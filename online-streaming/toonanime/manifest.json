{
  "id": "toonanime-online-streaming",
  "name": "FR | ToonAnime",
  "version": "1.1.3",
  "manifestURI": "https://raw.githubusercontent.com/TropicalFrog3/seanime-extension/refs/heads/main/online-streaming/toonanime/manifest.json",
  "language": "typescript",
  "type": "onlinestream-provider",
  "description": "ToonAnime est une extension Seanime en français pour regarder des anime doublés (VF) et sous-titrés (VOSTFR) depuis ToonAnime.biz, avec prise en charge multi‑serveurs et intégration de riches métadonnées.",
  "author": "TropicalFrog3",
  "icon": "https://raw.githubusercontent.com/TropicalFrog3/seanime-extension/refs/heads/main/online-streaming/toonanime/favicon.png",
  "website": "",
  "lang": "fr",
  "payload": "/// <reference path=\"../_external/.onlinestream-provider.d.ts\" />\n/// <reference path=\"../_external/core.d.ts\" />\n//#region type\ntype ToonAnimeEpisodesDetails = {\n    type: string;\n    data:\n    {\n        pageMetaTags: {\n            title: string;\n            description: string;\n            openGraph: {\n                title: string;\n                image: string;\n                description: string;\n                type: string;\n                site_name: string;\n            };\n            keywords: (string | string[])[];\n            robots: string;\n        };\n        post: {\n            status: boolean;\n            data: {\n                id: number;\n                title: string;\n                status: string;\n                duration: string;\n                score: string;\n                vote_plus: number;\n                vote_minus: number;\n                total_vote: number;\n                image_url: string;\n                cover_url: string; // use this if normalized\n                anilistid: number;\n                year: string;\n                related_saison: any[];\n                season: string;\n                romaji: string;\n                userPreferredTitle: string;\n                native: string;\n                synonyms: string[];\n                mal_id: number;\n                isAdult: boolean;\n                url: string;\n                totalEpisodes: string;\n                rating: string;\n                synopsis: string;\n                episodeslist: EpisodesList[];\n                currentEpisode: string;\n                rank: string;\n                popularity: string;\n                categorie: string;\n                categorie_url: string;\n                trailer_url: string;\n                source: string;\n                nextAiringEpisode: {\n                    airingAt: number;\n                    timeUntilAiring: number;\n                    episode: number;\n                };\n                hashtag: string | null;\n                broadcast: string | null;\n                created_at: string;\n                updated_at: string;\n                studios: { id: number; studio: string }[];\n                genres: string[];\n            };\n            characters: {\n                id: number;\n                name: string;\n                image: string;\n                role: string;\n            }[];\n            recommendations: {\n                id: number;\n                title: string;\n                totalEpisodes: string;\n                categories: string;\n                image: string;\n                url: string;\n            }[];\n        };\n    };\n    uses: {\n        params: string[];\n    };\n};\n\ntype EpisodesList = {\n    id: number;\n    image: string | null;\n    title: string;\n    number: number;\n    description: string;\n    data: {\n        [key: string]: {\n            server_id: string;\n            server_type: string;\n            server_number: string;\n            server_name: string;\n            server_url: string;\n            timestamps: any[];\n            quality: string;\n            server_source_type: string;\n        };\n    };\n};\n\ntype ToonAnimeSearchResult = {\n    status: boolean,\n    data: ToonData[],\n    hasNext: boolean\n    hasPrev: boolean\n    total: number,\n    page: number,\n    adminMessage: string[]\n};\n\ntype ToonData = {\n    id: number,\n    title: string,\n    romaji: string,\n    cat_url: string,\n    native: string,\n    synonyms: string[],\n    mal_id: number,\n    status: string,\n    isAdult: boolean,\n    url: string,\n    synopsis: string,\n    image: string,\n    categorie: string,\n    categorie_url: string,\n    createdate: string,\n    editedate: string,\n    popularity: string,\n    score: string,\n    quality: string | null,\n    total_episodes: string,\n    current_episode: string,\n    year: string,\n    duration: string,\n    updated_at: string,\n    created_at: string\n};\n//#endregion\n\nenum ToonAnimeServer {\n    SIBNET = \"sibnet\",\n    VIDCDN = \"VidCDN\",\n    CDN1 = \"CDN 1\",\n    VIDM = \"vidm\"\n}\n\nconst DecodeHtml = s => s.replace(/&#34;/g, '\"').replace(/&#39;/g, \"'\").replace(/&amp;/g, \"&\").replace(/([{,]\\s*)([a-zA-Z0-9_]+)(\\s*:)/g, '$1\"$2\"$3');\n\nclass Provider {\n\n    //#region Fetch\n    async FetchServerHandler(url: string, _server: string): Promise<EpisodeServer> {\n        const server: ToonAnimeServer = _server as ToonAnimeServer;\n        switch (server) {\n            case ToonAnimeServer.SIBNET:\n                return await this.FetchUrlSibnet(url);\n            case ToonAnimeServer.VIDCDN:\n                return await this.FetchUrlVidCDN(url);\n            case ToonAnimeServer.CDN1:\n                return await this.FetchUrlCDN1(url);\n            case ToonAnimeServer.VIDM:\n                return await this.FetchUrlVidM(url);\n            default:\n                return <EpisodeServer>{\n                    server: _server,\n                    headers: {},\n                    videoSources: []\n                };\n        }\n    }\n\n    async FetchUrlSibnet(url: string): Promise<EpisodeServer> {\n        const req = await fetch(url);\n        const html = await req.text();\n        const $ = LoadDoc(html);\n\n        const videos: VideoSource[] = [];\n        const headers = {\n            Host: \"video.sibnet.ru\",\n            \"User-Agent\": \"Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:141.0) Gecko/20100101 Firefox/141.0\",\n            Accept: \"video/webm,video/ogg,video/*;q=0.9,application/ogg;q=0.7,audio/*;q=0.6,*/*;q=0.5\",\n            \"Accept-Language\": \"fr,fr-FR;q=0.8,en-US;q=0.5,en;q=0.3\",\n            Range: \"bytes=0-\",\n            \"Sec-GPC\": \"1\",\n            Connection: \"keep-alive\",\n            Referer: url,\n            Cookie: \"__ddg1_=;__ddg2_=;\",\n            \"Sec-Fetch-Dest\": \"video\",\n            \"Sec-Fetch-Mode\": \"no-cors\",\n            \"Sec-Fetch-Site\": \"same-origin\",\n            AcceptEncoding: \"identity\",\n            Priority: \"u=0\"\n        }\n\n        const ScriptItems = $(`script[type=\"text/javascript\"]`);\n        for (let i = 0; i < ScriptItems.length(); i++) {\n            const ScriptContent = ScriptItems.eq(i).html();\n            if (ScriptContent) {\n                const PlayerContent = DecodeHtml(ScriptContent).split(\"player.src([\")[1]?.split(\"]),\")[0];\n                if (PlayerContent) {\n                    const videoUrl = PlayerContent.split(\",\")[0]?.split(\":\")[1]?.trim().replace(/['\"]/g, \"\");\n\n                    if (videoUrl) {\n                        // CANNOT FIND A WAY TO GET VIDEO QUALITY\n                        videos.push({\n                            url: `https://video.sibnet.ru${videoUrl}`,\n                            type: \"mp4\",\n                            quality: \"(sibnet) 720p\",\n                            subtitles: []\n                        });\n                    }\n                }\n            }\n        }\n\n        return <EpisodeServer>{\n            server: ToonAnimeServer.SIBNET,\n            headers: headers,\n            videoSources: videos\n        };\n    }\n\n    async FetchUrlVidCDN(url?: string): Promise<EpisodeServer> {\n        return <EpisodeServer>{\n            server: ToonAnimeServer.VIDCDN,\n            headers: {\n                Referer: url,\n            },\n            videoSources: []\n        };\n    }\n\n    async FetchUrlCDN1(url?: string): Promise<EpisodeServer> {\n        return <EpisodeServer>{\n            server: ToonAnimeServer.CDN1,\n            headers: {\n                Referer: url,\n            },\n            videoSources: []\n        };\n    }\n\n    async FetchUrlVidM(url: string): Promise<EpisodeServer> {\n        const req = await fetch(url);\n        const html = await req.text();\n        const $ = LoadDoc(html);\n\n        const Scripts = $(\"script[type='text/javascript']\");\n        const videos: VideoSource[] = [];\n\n        for (let i = 0; i < Scripts.length(); i++) {\n            const ScriptContent = Scripts.eq(i).html();\n            if (ScriptContent) {\n                const PlayerContent = DecodeHtml(ScriptContent).split(\"player.setup(\")[1]?.split(\");\")[0];\n                if (PlayerContent) {\n                    const fileSources = PlayerContent.split('\"file\":\"')[1]?.split('\"')[0];\n                    const req2 = await fetch(fileSources);\n                    const m3u8 = await req2.text();\n\n                    let qual = \"\";\n                    let m = \"\";\n\n                    m3u8.split(\"\\n\").forEach(line => {\n                        if (line.startsWith(\"#EXT-X-STREAM-INF\")) {\n                            qual = line.split(\"RESOLUTION=\")[1]?.split(\",\")[0] || \"unknown\";\n                            const width = parseInt(qual.split(\"x\")[0]) || 0;\n\n                            if (width >= 1920) {\n                                qual = \"1080p\";\n                            } else if (width >= 1280) {\n                                qual = \"720p\";\n                            } else if (width >= 640) {\n                                qual = \"480p\";\n                            } else if (width >= 320) {\n                                qual = \"360p\";\n                            } else {\n                                qual = \"unknown\";\n                            }\n                        }\n                        else if (line.startsWith(\"http\")) {\n                            m = line;\n                        }\n\n                        if (m && qual) {\n                            videos.push({\n                                url: m,\n                                type: \"m3u8\",\n                                quality: `(${ToonAnimeServer.VIDM}) ${qual}`,\n                                subtitles: []\n                            })\n                            m = \"\";\n                            qual = \"\";\n                        }\n                    });\n                    break;\n                }\n            }\n        }\n        return <EpisodeServer>{\n            server: ToonAnimeServer.VIDM,\n            headers: {\n                Referer: url,\n            },\n            videoSources: videos,\n        };\n    }\n    //#endregion\n\n    private readonly SEARCH_URL = \"https://api2.toonanime.biz/filter?\";\n    private readonly BASE_URL = \"https://www.toonanime.biz/\";\n\n    getSettings(): Settings {\n        return {\n            episodeServers: [ToonAnimeServer.SIBNET, ToonAnimeServer.VIDCDN, ToonAnimeServer.CDN1, ToonAnimeServer.VIDM],\n            supportsDub: true,\n        };\n    }\n\n    async search(opts: SearchOptions): Promise<SearchResult[]> {\n        const params = new URLSearchParams({\n            keyword: opts.query,\n            cat: opts.dub ? \"Anime VF\" : \"Anime VOSTFR\",\n            status: \"all\",\n            genre: \"\",\n            order: \"default\",\n            year: \"all\",\n            limit: \"21\"\n        });\n        const url = this.SEARCH_URL + params.toString();\n\n        const req = await fetch(url, {\n            method: \"GET\",\n            headers: {\n                \"Accept\": \"application/json\",\n                \"User-Agent\": \"Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:141.0) Gecko/20100101 Firefox/141.0\",\n            }\n        });\n\n        if (!req.ok) {\n            throw new Error(`Request failed with status ${req.status}`);\n        }\n\n        const data = (await req.json()) as ToonAnimeSearchResult;\n        const results: SearchResult[] = [];\n\n        data.data.forEach(element => {\n            if (opts.dub) {\n                // FIND DUB VERSION\n                results.push({\n                    id: `${element.categorie_url}/${element.url}{${element.current_episode}}`,\n                    title: element.title,\n                    url: element.url,\n                    subOrDub: \"dub\"\n                });\n            }\n            else {\n                // FIND SUB VERSION\n                results.push({\n                    id: `${element.categorie_url}/${element.url}{${element.current_episode}}`,\n                    title: element.title,\n                    url: element.url,\n                    subOrDub: \"sub\"\n                });\n            }\n        });\n        return results;\n    }\n\n    async findEpisodes(id: string): Promise<EpisodeDetails[]> {\n        // THIS IS DUMB LMAO\n        const number = id.split(\"{\")[1]?.split(\"}\")[0];\n        id = id.split(\"{\")[0];\n\n        const episodes: EpisodeDetails[] = [];\n        // fuck it, fucking global variable doesnt work static too... tried everything i know\n        const html = await fetch(this.BASE_URL + id).then(res => res.text());\n\n        for (let i = 1; i <= (number ? parseInt(number) : 1); i++) {\n            episodes.push({\n                id: id,\n                number: i,\n                url: html,\n            });\n        }\n        return episodes;\n    }\n\n    async findEpisodeServer(episode: EpisodeDetails, _server: string): Promise<EpisodeServer> {\n        async function GetServerUrl(server: string, html: string, ep: number): Promise<string | undefined> {\n            const $ = LoadDoc(html);\n            const ScriptItems = $(\"script\");\n\n            for (let i = 0; i < ScriptItems.length(); i++) {\n                const htmlScript = ScriptItems.eq(i).html();\n                if (!htmlScript || !htmlScript.includes(\"const data = [\")) continue;\n\n                const startIdx = htmlScript.indexOf(\"const data = \");\n                if (startIdx === -1) continue;\n\n                const afterStart = htmlScript.slice(startIdx + 13);\n                const endIdx = afterStart.indexOf(\"];\");\n                const rawData = afterStart.slice(0, endIdx !== -1 ? endIdx + 1 : undefined);\n\n                let details: ToonAnimeEpisodesDetails[];\n                try {\n                    details = JSON.parse(DecodeHtml(rawData));\n                } catch {\n                    continue;\n                }\n\n                for (const { data } of details) {\n                    const episodes = data?.post?.data?.episodeslist;\n                    if (!episodes) continue;\n\n                    const episodeEntry = episodes.find(e => e.number === ep);\n                    if (!episodeEntry) continue;\n\n                    for (const serverData of Object.values(episodeEntry.data)) {\n                        if (serverData.server_name.toLowerCase() === server.toLowerCase()) {\n                            return serverData.server_url;\n                        }\n                    }\n                }\n            }\n\n            return undefined;\n        }\n        const url = await GetServerUrl(_server, episode.url, episode.number);\n        if (!url) {\n            return <EpisodeServer>{\n                server: _server,\n                headers: {},\n                videoSources: []\n            }\n        }\n        return await this.FetchServerHandler(url, _server);\n    }\n}"
}
